name: Mynah UI - E2E Tests (Linux)
on:
    workflow_call:
    push:
        branches:
            - main
        paths:
            - 'mynah-ui/**'
    pull_request:
        paths:
            - 'mynah-ui/**'

jobs:
    e2e-linux:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GitHub Container Registry
              if: ${{ github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push' }}
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build E2E tests Docker Image (with cache)
              if: ${{ github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push' }}
              uses: docker/build-push-action@v5
              with:
                  context: ./mynah-ui
                  push: false
                  load: true
                  tags: mynah-ui-e2e:latest
                  cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/mynah-ui-e2e:buildcache
                  cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/mynah-ui-e2e:buildcache,mode=max

            - name: Build E2E tests Docker Image (no cache - fork PRs)
              if: ${{ github.event.pull_request.head.repo.full_name != github.repository && github.event_name != 'push' }}
              uses: docker/build-push-action@v5
              with:
                  context: ./mynah-ui
                  push: false
                  load: true
                  tags: mynah-ui-e2e:latest

            - name: Run E2E tests Docker Container
              run: npm run docker:run
              working-directory: ./mynah-ui
              env:
                  WEBKIT_FORCE_COMPLEX_TEXT: 0
                  WEBKIT_DISABLE_COMPOSITING_MODE: 1
                  PLAYWRIGHT_BROWSERS_PATH: 0

            - name: Extract test results from Docker container
              if: always()
              run: npm run docker:extract
              working-directory: ./mynah-ui

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: mynah-ui-test-results
                  path: ./mynah-ui/ui-tests/__results__
                  retention-days: 30

    report:
        needs: e2e-linux
        if: always()
        uses: ./.github/workflows/mynah-ui-test-report.yml
